# ProtoActor C++ 架构设计

本文档描述 ProtoActor C++ 的整体架构设计和模块组织。

---

## 一、架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Application Layer                         │
│                    (User-defined Actors)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Actor System                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  Props   │ │ Context  │ │   PID    │ │ Process  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ Mailbox  │ │Dispatcher│ │Behavior  │ │Middleware│           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Infrastructure                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │Process   │ │ Event    │ │  Dead    │ │ThreadPool│           │
│  │Registry  │ │ Stream   │ │ Letter   │ │          │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Remote & Cluster                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  Remote  │ │Endpoint  │ │ Cluster  │ │  PubSub  │           │
│  │          │ │ Manager  │ │          │ │          │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │Serializer│ │Blocklist │ │ Gossiper │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Persistence Layer                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │Provider  │ │  Event   │ │Snapshot  │                        │
│  │  State   │ │ Sourcing │ │          │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、核心模块

### 2.1 Actor 模型

```
┌─────────────────────────────────────┐
│              Actor                   │
│  ┌─────────────────────────────┐    │
│  │       Receive(msg)          │    │
│  └─────────────────────────────┘    │
│                │                     │
│                ▼                     │
│  ┌─────────────────────────────┐    │
│  │     Message Handler         │    │
│  │  ┌─────┐ ┌─────┐ ┌─────┐   │    │
│  │  │Msg1 │ │Msg2 │ │MsgN │   │    │
│  │  └─────┘ └─────┘ └─────┘   │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

**关键组件**:
- `Actor`: 抽象基类，定义 `Receive` 方法
- `Context`: Actor 上下文，提供消息处理、子 Actor 管理等功能
- `PID`: 进程标识符，唯一标识一个 Actor
- `Props`: Actor 配置，包含生产者、调度器、监督策略等

### 2.2 消息传递

```
┌─────────┐    Send/Request    ┌─────────┐
│ Sender  │ ──────────────────►│ Receiver│
│ Actor   │                    │ Actor   │
└─────────┘◄────────────────── └─────────┘
                  Response
```

**消息类型**:
- 普通消息: 异步发送，不等待响应
- Request-Response: 发送并等待响应
- Future: 异步请求，返回 Future 对象

### 2.3 生命周期

```
    ┌─────────┐
    │ Created │
    └────┬────┘
         │ Spawn
         ▼
    ┌─────────┐
    │ Started │
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │ Running │◄────────┐
    └────┬────┘         │
         │              │
    ┌────┴────┐         │
    │         │         │
    ▼         ▼         │
┌───────┐ ┌────────┐    │
│ Error │ │Stopped │    │
└───┬───┘ └────────┘    │
    │                   │
    ▼         Restart   │
┌─────────┐ ────────────┘
│Restarting│
└─────────┘
```

---

## 三、调度系统

### 3.1 调度器架构

```
┌─────────────────────────────────────┐
│           Dispatcher                │
│  ┌─────────────────────────────┐    │
│  │      Mailbox Queue          │    │
│  │  ┌───┐ ┌───┐ ┌───┐ ┌───┐  │    │
│  │  │ M │ │ M │ │ M │ │ M │  │    │
│  │  └───┘ └───┘ └───┘ └───┘  │    │
│  └─────────────────────────────┘    │
│                │                     │
│                ▼                     │
│  ┌─────────────────────────────┐    │
│  │      Thread Pool            │    │
│  │  ┌─────┐ ┌─────┐ ┌─────┐   │    │
│  │  │ T1  │ │ T2  │ │ TN  │   │    │
│  │  └─────┘ └─────┘ └─────┘   │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

**调度器类型**:
- `DefaultDispatcher`: 高吞吐量，适合计算密集型
- `SynchronizedDispatcher`: 低延迟，保证消息顺序

---

## 四、监督策略

### 4.1 监督层次

```
┌─────────────────────────────────────┐
│           Supervisor                 │
│  ┌─────────────────────────────┐    │
│  │      Supervision Strategy   │    │
│  │  ┌─────────────────────┐   │    │
│  │  │ Decider Function    │   │    │
│  │  └─────────────────────┘   │    │
│  └─────────────────────────────┘    │
│                │                     │
│       ┌────────┼────────┐           │
│       ▼        ▼        ▼           │
│  ┌────────┐ ┌────────┐ ┌────────┐  │
│  │ Child1 │ │ Child2 │ │ Child3 │  │
│  └────────┘ └────────┘ └────────┘  │
└─────────────────────────────────────┘
```

**指令类型**:
- `Resume`: 继续处理下一条消息
- `Restart`: 重启 Actor
- `Stop`: 停止 Actor
- `Escalate`: 将错误上报给父 Actor

---

## 五、远程通信

### 5.1 远程架构

```
┌────────────────────────────────────────────────────────────┐
│                      Node 1                                │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ Actor A  │───►│ Endpoint     │───►│ gRPC Client  │     │
│  └──────────┘    │ Manager      │    └──────────────┘     │
│                  └──────────────┘                          │
└────────────────────────────────────────────────────────────┘
                         │
                         │ Network (HTTP/2)
                         ▼
┌────────────────────────────────────────────────────────────┐
│                      Node 2                                │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ Actor B  │◄───│ Endpoint     │◄───│ gRPC Server  │     │
│  └──────────┘    │ Manager      │    └──────────────┘     │
│                  └──────────────┘                          │
└────────────────────────────────────────────────────────────┘
```

### 5.2 序列化

```
┌─────────────┐    Serialize    ┌─────────────┐
│   Message   │ ───────────────►│   Bytes     │
│   (C++)     │                 │  (Wire)     │
└─────────────┘                 └─────────────┘
       │                               │
       │                               │
       ▼                               ▼
┌─────────────┐    Deserialize  ┌─────────────┐
│  Protobuf   │ ◄───────────────│   Bytes     │
│  / JSON     │                 │  (Wire)     │
└─────────────┘                 └─────────────┘
```

---

## 六、集群支持

### 6.1 集群架构

```
┌─────────────────────────────────────────────────────────────┐
│                       Cluster                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                   Member List                          │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │ │
│  │  │ Member1 │ │ Member2 │ │ Member3 │ │ Member4 │     │ │
│  │  │ Node A  │ │ Node B  │ │ Node C  │ │ Node D  │     │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘     │ │
│  └───────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                   Gossip Protocol                      │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │ │
│  │  │ Gossip  │◄────────►│ Gossip  │◄────────►│ Gossip  │ │
│  │  │ Node A  │         │ Node B  │         │ Node C  │ │
│  │  └─────────┘         └─────────┘         └─────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、持久化

### 7.1 事件溯源

```
┌─────────────┐     Persist     ┌─────────────┐
│   Event     │ ───────────────►│  Provider   │
│             │                 │   State     │
└─────────────┘                 └─────────────┘
       │                               │
       │         Replay                │
       └───────────────────────────────┘
```

---

## 八、目录结构

```
protoactor-cpp/
├── include/external/          # 头文件
│   ├── actor.h                  # Actor 基类
│   ├── context.h                # 上下文接口
│   ├── pid.h                    # 进程标识符
│   ├── props.h                  # Actor 配置
│   ├── behavior.h               # 行为管理
│   ├── supervision.h            # 监督策略
│   ├── cluster/                 # 集群模块
│   ├── remote/                  # 远程通信
│   └── router/                  # 路由系统
├── src/                         # 源文件
│   ├── actor/                   # Actor 核心实现
│   ├── cluster/                 # 集群实现
│   ├── remote/                  # 远程实现
│   └── router/                  # 路由实现
├── examples/                    # 示例代码
├── tests/                       # 测试
│   ├── unit/                    # 单元测试
│   ├── functional/              # 功能测试
│   ├── integration/             # 集成测试
│   └── scripts/                 # 测试脚本
└── docs/                        # 文档
```

---

## 九、设计原则

1. **最小化 API**: 保持接口简洁易用
2. **基于成熟技术**: 使用 gRPC、Protobuf 等成熟库
3. **数据传递**: 显式序列化，跨语言兼容
4. **性能优先**: 零成本抽象，高效内存管理
5. **并发安全**: 基于 Actor 模型，避免共享状态

---

## 十、扩展阅读

- [对比与迁移指南](COMPARISON_AND_MIGRATION.md)
- [构建指南与远程配置](BUILD_AND_REMOTE.md)
- [API参考文档](API_REFERENCE.md)
- [测试与性能指南](../tests/TESTING.md)
